<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUJ CSE - Secure Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --success: #059669; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; }
        * { box-sizing: border-box; transition: all 0.2s ease; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; user-select: none; -webkit-user-select: none; }
        
        .container { background: var(--card); padding: 40px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 800px; border: 1px solid #e2e8f0; animation: slideUp 0.5s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h2 { font-weight: 700; color: var(--primary); text-align: center; margin-bottom: 30px; }
        input[type="text"], input[type="number"] { width: 100%; padding: 14px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; outline: none; }
        
        /* MASKED INPUT TO BYPASS PASSWORD MANAGER */
        .masked-input { 
            -webkit-text-security: disc; /* For Chrome/Brave/Safari */
            text-security: disc; 
            font-family: password; /* Fallback */
        }

        button { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-sync { background: var(--success); color: white; }
        .btn-backup { background: #64748b; color: white; }

        .q-card { background: #f8fafc; padding: 25px; border-radius: 15px; margin-bottom: 25px; border-left: 6px solid var(--primary); }
        label { display: flex; align-items: center; justify-content: flex-start; text-align: left; padding: 14px 20px; background: white; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; margin-bottom: 12px; font-weight: 500; }
        label:hover { border-color: var(--primary); background: #eff6ff; }
        
        input[type="radio"] { width: 20px; height: 20px; margin: 0 15px 0 0; flex-shrink: 0; cursor: pointer; }
        .hidden { display: none !important; }
        .badge { background: #dbeafe; color: #1e40af; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        #warning { background: #fef2f2; color: #991b1b; padding: 12px; border-radius: 12px; text-align: center; font-weight: 700; margin-bottom: 25px; border: 1px solid #fee2e2; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="container">
    <div id="v-lock">
        <h2>Station Locked</h2>
        <input type="text" id="gate-key" class="masked-input" placeholder="Instructor Access Key" autocomplete="off">
        <input type="number" id="q-count" value="10" placeholder="Questions count">
        <button class="btn-primary" onclick="unlock()">Authorize Station</button>
    </div>

    <div id="v-login" class="hidden">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <span class="badge">MUJ LAB CONSOLE</span>
            <span class="badge" style="background:#ecfdf5; color:#065f46;">Records: <span id="rec-count">0</span></span>
        </div>
        <h2>Student Registration</h2>
        <input type="text" id="s-name" placeholder="Full Name" autocomplete="off">
        <input type="text" id="s-reg" placeholder="Registration Number" autocomplete="off">
        <button class="btn-primary" id="start-btn" onclick="start()">Launch Assessment</button>
        
        <div style="margin-top:40px; padding-top:20px; border-top: 2px dashed #e2e8f0;">
            <p style="color:#64748b; font-weight:600; margin-bottom:10px;">Instructor Panel</p>
            <input type="text" id="sync-pass" class="masked-input" placeholder="Sync Key" autocomplete="off">
            <button class="btn-sync" onclick="runSync()">Sync to Cloud</button>
            <button class="btn-backup" onclick="runBackup()">Download CSV Backup</button>
        </div>
    </div>

    <div id="v-quiz" class="hidden">
        <div id="warning">⚠️ ANTI-CHEAT ACTIVE: DO NOT SWITCH TABS</div>
        <div id="q-container"></div>
        <button class="btn-primary" onclick="submit()">Submit Final Attempt</button>
    </div>

    <div id="v-done" class="hidden" style="text-align:center;">
        <div style="font-size: 60px; margin-bottom: 20px;">✅</div>
        <h2>Submission Saved</h2>
        <button class="btn-primary" onclick="reset()">Next Student</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz7qImy-9xpWvpY6nctE5u1rYwS7wd1EMJgmA7fFgZy1FDXhvvxuc14MEjnddiGN7rkXA/exec";
    const SECRET_KEY = "abcd@1234";
    let isQuizActive = false, currentQuestions = [], teacherToken = "", questionCount = 10;

    // --- SECURITY FIX: RELY ONLY ON VISIBILITY ---
    function penalty(reason) {
        if (isQuizActive) {
            isQuizActive = false;
            alert("VIOLATION: " + reason + ". Your score is recorded as 0.");
            saveRecord(0, "Cheating (" + reason + ")");
            if (document.exitFullscreen) document.exitFullscreen();
        }
    }

    // Only triggers when tab is hidden (True Tab Switch)
    document.addEventListener("visibilitychange", () => {
        if (document.hidden && isQuizActive) penalty("Tab Switched");
    });

    // Detect Exit Fullscreen (Esc Key)
    document.addEventListener("fullscreenchange", () => {
        if (!document.fullscreenElement && isQuizActive) penalty("Exited Fullscreen");
    });

    // Disable Right Click & Inspect
    document.onkeydown = (e) => {
        if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) || (e.ctrlKey && e.keyCode == 85)) return false;
    };

    // --- APP LOGIC ---
    function unlock() {
        teacherToken = document.getElementById('gate-key').value;
        questionCount = parseInt(document.getElementById('q-count').value);
        if (teacherToken === SECRET_KEY) {
            showView('v-lock', 'v-login');
            updateBadge();
        } else alert("Invalid Key");
    }

    async function start() {
        const name = document.getElementById('s-name').value, reg = document.getElementById('s-reg').value;
        if (!name || !reg) return alert("Enter Name/Reg No.");
        
        if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();

        const btn = document.getElementById('start-btn');
        btn.innerText = "Loading Questions...";
        btn.disabled = true;

        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "fetch", token: teacherToken, count: questionCount }) });
            const data = await res.json();
            if (data.result === "success") {
                currentQuestions = data.questions;
                renderQuestions();
                showView('v-login', 'v-quiz');
                isQuizActive = true;
            } else alert(data.message);
        } catch (e) { alert("Connectivity error."); }
        finally { btn.innerText = "Launch Assessment"; btn.disabled = false; }
    }

    function renderQuestions() {
        document.getElementById('q-container').innerHTML = currentQuestions.map((q, i) => `
            <div class="q-card">
                <b style="display:block; margin-bottom:15px; font-size:1.1rem;">${i+1}. ${q.q}</b>
                ${q.options.map((opt, idx) => `<label><input type="radio" name="a${i}" value="${idx}"> ${opt}</label>`).join('')}
